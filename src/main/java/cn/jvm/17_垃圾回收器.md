# 17_垃圾回收器

## 一、GC分类与性能指标

* 不同厂商、不同版本的JVM可有自己的实现。
* 不同角度有不同分类。

> Java不同版本的新特性

1. 语法层面：

   Lambda，switch，自动装箱、拆箱、enum、泛型。

2. API层面：Stream API，新的日期时间，Optional，String，集合框架

3. 底层优化：

   JVM的GC变化、元空间、静态域、字符串常量池等。

### 1. 分类

#### 1) 按线程数分

* **串行**垃圾回收器
  * 适用于单核或较小内存等**资源受限的场景**。
* **并行**垃圾回收器
  * 适用于**并发能力较强**的CPU。
  * 并行使得**多个CPU同时执行**，提升了应用的吞吐量。
  * 仍然采用**独占式的STW机制**。

#### 2)按工作模式分

* **并发式**
  * GC线程与用户线程**交替工作**；
  * 尽可能减少用户线程停顿时间。
* **独占式**
  * GC时候**停止用户线程（STW）**。

#### 3)按碎片处理方式

* **压缩式**：执行碎片空间处理。
* **非压缩式**：不执行碎片空间处理。

#### 4) 按工作内存区间

* **年轻代**垃圾回收器
* **老年代**垃圾回收器

### 2. 性能指标

**吞吐量**、**暂停时间**、**内存占用**三者共同构成【**不可能三角**】，尽可能满足其中两项。

目前的标准：在**最大吞吐量优先**的情况下，**降低停顿时间**。

#### 1) **吞吐量（Throughput）**

**用户代码运行时间占比**总运行时间。

![吞吐量与暂停时间](ref/吞吐量与暂停时间.svg)

#### 2) 垃圾收集开销

吞吐量的补数，**GC时间占比**总运行时间。

#### 3) **暂停时间**

用户线程被暂停的时间。

#### 4) 收集频率

相对于应用程序执行，收集操作的发生频率。

#### 5) **内存占用**

Java堆区所占内存的大小。

#### 6) 快速

一个对象从诞生到被回收经历的时间。

## 二、不同垃圾回收器概述

### 1. 发展历史

1. 1999年随**JDK1.3.1**一起来的是**串行方式的serial GC** ，它是第一款GC。ParNew垃圾收集器是serial收集器的多线程版本
2. 2002年2月26日，**JDK1.4.2**，**Parallel GC** 和**Concurrent Mark Sweep GC**一起发布
3. 在**JDK6之后**，**Para1lel Gc**成为**HotSpot默认**GC.
4. 2012年，在**JDK1.7u4**版本中，**G1可用**。
5. 2017年，**JDK9**中**G1变成默认**的GC，以替代CMS。
6. 2018年3月，**JDK10**中**G1 GC**的**并行完整垃圾回收**，实现并行性来改善最坏情况下的延迟。
7. 2018年9月，**JDK11**发布。引入**Epsilon（ε）**垃圾回收器，又被称为**【No-op】（无操作）**回收器。同时，引入**ZGC**:**可伸缩的低延迟**垃圾回收器(Experimental)。
8. 2019年3月，**JDK12**发布。**增强G1** GC，**自动返回未用堆内存给操作系统**。同时，引入**Shenandoah GC**:**低停顿时间的GC** (Experimental)。
9. 2019年9月，**JDK13**发布。**增强ZGC**，自动返回未用堆内存给操作系统。
10. 2020年3月，**JDK14**发布。**删除CMS**垃圾回收器。扩展ZGC在macos和windows
    上的应用

### 2. 垃圾收集器之间的配合关系

![垃圾收集器的关系](ref/垃圾收集器的关系.svg)

* 没有最优秀的垃圾回收器，只能根据使用场景选出最优的组合。

### 查看默认垃圾回收器

1. VM参数

   **-XX:+PrintCommandLineFlags** (查看命令行相关参数，包含使用的垃圾回收器）

2. 使用命令行指令

   **jinfo -flag [相关垃圾回收器参数]  [进程ID]**

## 三、Serial回收器：串行回收

### 1. 年轻代——Serial

1. JDK 1.3之前的唯一选择。
2. Hotspot VM在**Client模式**下，**新生代默认**。
3. 采用**复制算法**、**串行回收**、**STW机制**。

### 2. 老年代——Serial Old

1. **Client模式**下，老年代默认。
2. 采用**标记-压缩算法**、**串行回收**、**STW机制**。
3. **Server模式**下，两个用途：
   * 与**新生代的Parallel Scavenge**配合使用。
   * 作为**CMS的后备方案**。

### 3. 优势

**简单而高效**。对于限定**单CPU环境**来说，**无线程间交互**的开销。

### 4. 使用

VM参数：**-XX:+UseSerialGC**

## 四、ParNew回收器：并行回收

### 1. 概述

1. 是Parallel New缩写，用于**处理新生代**的垃圾回收，是Serial的**多线程版本**（新生代回收频繁，并行方式更高效）。
2. 采用**复制算法**、**STW机制**。
3. 很多JVM在**Server模式**下新生代默认。
4. **适用于多核CPU环境**，充分利用硬件资源提升吞吐量。在单核CPU环境，性能不及Serial。

### 2. 适用

1. VM参数设置启用：
   * **-XX:+UseParNewGC**
2. 限制线程数量：
   * **-XX:ParallelGCThreads**，默认等于CPU线程数

## 五、Parallel 收集器：吞吐量优先

> Java 8中默认组合。

### 1. 年轻代——Parallel Scavenge

1. 采用**复制算法**、**并行回收**、**STW机制**。
2. **可控制的吞吐量**。
* 适合**后台运算**、**不需要太多交互**的场景。
3. **自适应调节**策略。

### 2. 老年代——Parallel Old

1. JDK 1.6时提出，用于**替换Serial Old**。
2. 采用**标记-压缩算法**、**并行回收**、**STW机制**。

## 六、CMS回收器：低延迟

## 七、G1回收器：区域化分代式

## 八、垃圾回收器小结

## 九、GC日志分析

## 十、垃圾回收器的新发展